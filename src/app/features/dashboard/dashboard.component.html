<div class="grid grid-3" style="margin-bottom:16px;">
  <div class="kpi-card" style="padding:16px; display:flex; align-items:center; gap:12px;" (click)="updateDetails('Entregadas')">
    <div style="width:44px; height:44px; border-radius:8px;" class="cso-gradient-green"></div>
    <div>
      <div class="text-muted-contrast">Entregadas</div>
      <div class="kpi-number">{{kpi().entregadas}}</div>
    </div>
  </div>
  <div class="kpi-card" style="padding:16px; display:flex; align-items:center; gap:12px;" (click)="updateDetails('En proceso y en tiempo')">
    <div style="width:44px; height:44px; border-radius:8px; background: var(--cso-primary);"></div>
    <div>
      <div class="text-muted-contrast">En proceso y en tiempo</div>
      <div class="kpi-number">{{kpi().enTiempo}}</div>
    </div>
  </div>
  <div class="kpi-card" style="padding:16px; display:flex; align-items:center; gap:12px;" (click)="updateDetails('En proceso y fuera de tiempo')">
    <div style="width:44px; height:44px; border-radius:8px;" class="cso-gradient"></div>
    <div>
      <div class="text-muted-contrast">En proceso y fuera de tiempo</div>
      <div class="kpi-number">{{kpi().fueraTiempo}}</div>
    </div>
  </div>
</div>
@if (showTimeDetails != null) {
  <section class="cso-card" style="padding:16px; margin-bottom:16px;">
    <div style="display:flex; justify-content: space-between; align-items: center; width: 100%;">
      <h3>{{ showTimeDetails }}</h3>
      <i class="bi bi-caret-up" style="padding-right: 1.5rem;" (click)="closeDetails()"></i>
    </div>

    <div style="overflow:auto;">
      <table mat-table [dataSource]="dataSource" matSort [matSortActive]="'id'" matSortDirection="asc" class="cso-mat-table mat-elevation-z0">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.id }}</td>
        </ng-container>

        <ng-container matColumnDef="nombrePlataforma">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Plataforma</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.nombrePlataforma }}</td>
        </ng-container>

        <ng-container matColumnDef="area">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>√Årea</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.area }}</td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.tipo }}</td>
        </ng-container>

        <ng-container matColumnDef="fechaSolicitud">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Solicitud</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.fechaSolicitud | date: 'shortDate' }}</td>
        </ng-container>

        <ng-container matColumnDef="fechaCompromiso">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Compromiso</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.fechaCompromiso ? (delivery.fechaCompromiso | date: 'shortDate') : '‚Äî' }}</td>
        </ng-container>

        <ng-container matColumnDef="fechaEntrega">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Entrega</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.fechaEntrega ? (delivery.fechaEntrega | date: 'shortDate') : '‚Äî' }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.status }}</td>
        </ng-container>

        <ng-container matColumnDef="observaciones">
          <th mat-header-cell *matHeaderCellDef>Observaciones</th>
          <td mat-cell *matCellDef="let delivery">{{ delivery.observaciones || '‚Äî' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="detailDisplayedColumns()"></tr>
        <tr mat-row *matRowDef="let row; columns: detailDisplayedColumns();"></tr>

        <tr class="mat-row" matNoDataRow>
          <td class="mat-cell" [attr.colspan]="detailDisplayedColumns().length">Sin resultados para "{{ showTimeDetails }}"</td>
        </tr>
      </table>
    </div>
    <mat-paginator [pageSize]="10" [pageSizeOptions]="[10,25,50,100]" showFirstLastButtons></mat-paginator>
  </section>
}


<section class="cso-card" style="padding:16px; margin-bottom:16px;">
  <h3 style="margin:0 0 12px 0;">Filtros</h3>
  <div class="form-row">
    <div class="form-field">
      <label>√Åreas</label>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <label class="cso-check cso-check--filled cso-check--glow" *ngFor="let a of areas" style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" [checked]="selectedAreaSet().has(a)" (change)="toggleArea(a, $event.target.checked)" />
          <span>{{a}}</span>
        </label>
      </div>
      <div class="filter-actions" style="display:flex; gap:0.5rem;">
        <button class="cso-btn" (click)="selectAll()">Todas</button>
        <button class="cso-btn" (click)="clearAreas()">Ninguna</button>
      </div>
    </div>

    <div class="form-field">
      <label>Tipos de entrega</label>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <label class="cso-check cso-check--filled cso-check--glow" *ngFor="let t of types" style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" [checked]="selectedTypeSet().has(t)" (change)="toggleType(t, $event.target.checked)" />
          <span>{{t}}</span>
        </label>
      </div>
      <div class="filter-actions" style="display:flex; gap:0.5rem;">
        <button class="cso-btn" (click)="selectAllTypes()">Todos</button>
        <button class="cso-btn" (click)="clearTypes()">Ninguno</button>
      </div>
    </div>

    <div class="form-field">
      <label>Rango de fechas</label>
      <mat-form-field appearance="fill" class="cso-mat-field">
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate matInput placeholder="Desde" [(ngModel)]="dateFrom">
          <input matEndDate matInput placeholder="Hasta" [(ngModel)]="dateTo">
        </mat-date-range-input>
        <mat-datepicker-toggle [for]="picker">
          <span matDatepickerToggleIcon>üìÖ</span>
        </mat-datepicker-toggle>
        <mat-date-range-picker #picker (closed)="applyFilters()"></mat-date-range-picker>
      </mat-form-field>
      <div class="filter-actions" style="display:flex; gap:0.5rem;">
        <button class="cso-btn" (click)="resetDate()">Limpiar filtros</button>
      </div>
    </div>
  </div>
</section>

<section class="grid grid-2">
  <div class="chart-panel" role="img" aria-label="En tiempo vs Fuera de tiempo por √°rea">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h4 class="chart-title">En tiempo vs Fuera de tiempo por √Årea</h4>
      <div class="cso-legend"
           style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: right;">
        @for (item of colorMapArea; track item.tipo) {
          <div class="item">
            <span class="swatch" [style.background]="item.color"></span>
            <span>
      {{ item.tipo }}
    </span>
          </div>
        }

      </div>
    </div>
    <div class="cso-bars" *ngIf="areaAgg().length > 0; else noDataBars" style="margin-bottom: 3rem;">
        <div class="col" *ngFor="let r of areaAgg(); trackBy: trackArea">
          <div></div>
          <div class="bar time" [style.height.%]="barHeight(r.enTiempo)" [title]="tooltip(r, 'En tiempo')"></div>
          <div class="bar late" [style.height.%]="barHeight(r.fueraTiempo)" [title]="tooltip(r, 'Fuera de tiempo')"></div>
          <div class="xlabel">{{r.area}}</div>
        </div>
      </div>

    <ng-template #noDataBars>
      <div class="text-muted-contrast">Sin datos para los filtros seleccionados.</div>
    </ng-template>
  </div>

  <div class="chart-panel" role="img" aria-label="Distribuci√≥n por tipo de entrega">
    <h4 class="chart-title">Distribuci√≥n por tipo de entrega</h4>
    <div class="cso-donut" *ngIf="typeAgg().length > 0; else noDataDonut">
      <svg viewBox="0 0 220 220" aria-hidden="true">
        <g transform="translate(110,110) rotate(-90)">
          <ng-container *ngFor="let t of donutSets(); let i = index">
            <circle r="90" cx="0" cy="0" [attr.stroke]="t.color" stroke-width="24"
                    [attr.stroke-dasharray]="t.len + ' ' + (circumference - t.len)"
                    [attr.stroke-dashoffset]="t.offset"
                    fill="none"></circle>
          </ng-container>
        </g>
      </svg>
      <div class="cso-legend">
        <div class="item" *ngFor="let t of typeAgg()">
          <span class="swatch" [style.background]="t.color"></span>
          <span>{{t.tipo}}: {{t.total}} ({{percent(t.total, totalFiltered())}})</span>
        </div>
      </div>
    </div>
    <ng-template #noDataDonut>
      <div class="text-muted-contrast">Sin datos para los filtros seleccionados.</div>
    </ng-template>
  </div>
</section>
